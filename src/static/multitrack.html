<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multitrack Player</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 24px; background: #f3f4f6; color: #111827; }
    h1 { margin-top: 0; }
    .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(15,23,42,0.08); max-width: 1080px; margin: 0 auto; }
    button { border: none; border-radius: 8px; padding: 10px 16px; background: #2563eb; color: #fff; cursor: pointer; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .section { margin-top: 16px; }
    .list { border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; background: #f8fafc; max-height: 360px; overflow-y: auto; }
    .track-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0; }
    .track-row:last-child { border-bottom: none; }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; background: #e0e7ff; color: #1d4ed8; margin-left: 8px; }
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <div>
        <p class="muted" style="margin:0;">Utility</p>
        <h1 style="margin:4px 0 0 0;">Multitrack Player</h1>
        <p class="muted" style="margin:6px 0 0 0;">Load separate voice / sfx / music files and play them in sync.</p>
      </div>
      <a href="/" style="text-decoration:none; color:#2563eb;">← Back to Studio</a>
    </div>

    <div class="section">
      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button onclick="playAll()">▶ Play checked</button>
        <button style="background:#111827;" onclick="pauseAll()">⏸ Pause</button>
        <button style="background:#e5e7eb; color:#111827;" onclick="stopAll()">⏹ Stop</button>
      </div>
      <p id="status" class="muted" style="margin-top:10px;">Ready.</p>
    </div>

    <div class="section">
      <h3>Produced outputs (m4b)</h3>
      <div id="produced-list" class="list"></div>
    </div>

    <div class="section">
      <h3>Playground SFX (wav)</h3>
      <div id="sfx-list" class="list"></div>
    </div>

    <div class="section">
      <h3>Playground Music (wav)</h3>
      <div id="music-list" class="list"></div>
    </div>

    <div class="section">
      <h3>Voice tests (wav)</h3>
      <div id="voice-tests-list" class="list"></div>
    </div>
  </div>

  <script>
    const audioMap = new Map(); // id -> audio element
    let tracksData = { produced: [], playground_sfx: [], playground_music: [], voice_tests: [] };

    function setStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    function playAll() {
      setStatus('Loading tracks…');
      const checked = Array.from(document.querySelectorAll('.track-check:checked'));
      if (!checked.length) { setStatus('No tracks selected.'); return; }
      checked.forEach(cb => {
        const url = cb.dataset.url;
        const id = cb.dataset.id;
        let player = audioMap.get(id);
        if (!player) {
          player = new Audio(url);
          player.preload = 'auto';
          audioMap.set(id, player);
        } else if (player.src !== url) {
          player.src = url;
        }
        player.currentTime = 0;
      });
      Promise.all(checked.map(cb => {
        const player = audioMap.get(cb.dataset.id);
        if (!player) return Promise.resolve();
        return player.readyState >= 2 ? Promise.resolve() : new Promise(res => { player.oncanplay = res; });
      })).then(() => {
        checked.forEach(cb => {
          const player = audioMap.get(cb.dataset.id);
          if (player) player.play();
        });
        setStatus('Playing selected tracks.');
      }).catch(err => {
        console.error(err);
        setStatus('Error starting playback.');
      });
    }

    function pauseAll() {
      audioMap.forEach(p => p.pause());
      setStatus('Paused.');
    }

    function stopAll() {
      audioMap.forEach(p => { p.pause(); p.currentTime = 0; });
      setStatus('Stopped.');
    }

    function renderList(targetId, items, label) {
      const container = document.getElementById(targetId);
      if (!container) return;
      if (!items.length) { container.innerHTML = `<p class=\"muted\">No ${label} found.</p>`; return; }
      const rows = items.map((item, idx) => {
        const safeId = `${targetId}-${idx}`;
        return `<div class=\"track-row\">
          <label style=\"display:flex; align-items:center; gap:8px; cursor:pointer;\">
            <input type=\"checkbox\" class=\"track-check\" data-id=\"${safeId}\" data-url=\"${item.url}\" checked />
            <span>${item.name}</span>
            <span class=\"pill\">${label}</span>
          </label>
          <span class=\"muted\" style=\"font-size:0.8rem;\">${item.modified.split('T')[0]}</span>
        </div>`;
      }).join('');
      container.innerHTML = rows;
    }

    async function loadTracks() {
      try {
        const res = await fetch('/outputs/tracks');
        tracksData = await res.json();
        renderList('produced-list', tracksData.produced || [], 'voice');
        renderList('sfx-list', tracksData.playground_sfx || [], 'sfx');
        renderList('music-list', tracksData.playground_music || [], 'music');
        renderList('voice-tests-list', tracksData.voice_tests || [], 'voice');
      } catch (err) {
        console.error(err);
        setStatus('Failed to load tracks.');
      }
    }

    loadTracks();
  </script>
</body>
</html>
