<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audibound Studio</title>
    <style>
        :root {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: #111827;
            background-color: #f3f4f6;
        }

        body {
            margin: 0;
            padding: 24px;
            background: #f3f4f6;
        }

        h1 {
            margin-top: 0;
        }

        .layout {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 18px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        }

        input,
        textarea,
        select {
            font: inherit;
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
        }

        button {
            font: inherit;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            background: #2563eb;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #1e40af;
        }

        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin: 14px 0;
        }

        .tab {
            padding: 10px 20px;
            border-radius: 999px;
            border: 1px solid transparent;
            cursor: pointer;
            background: #e0e7ff;
            color: #1d4ed8;
        }

        .tab.active {
            background: #1d4ed8;
            color: #fff;
        }

        .two-column {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 18px;
        }

        .list {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            background: #f8fafc;
        }

        .list-item {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-bottom: 10px;
            background: #fff;
        }

        .list-item:last-child {
            margin-bottom: 0;
        }

        .small {
            font-size: 0.9rem;
            color: #475569;
        }

        .muted {
            color: #6b7280;
        }

        .history-entry {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 0;
        }

        .history-entry:last-child {
            border-bottom: none;
        }

        .pill {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: #e0f2fe;
            color: #0369a1;
        }

        .flash {
            border-radius: 10px;
            padding: 12px 16px;
            margin: 10px 0 20px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1d4ed8;
            display: none;
        }

        .flash.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .flash.success {
            background: #ecfdf5;
            border-color: #bbf7d0;
            color: #15803d;
        }

        .custom-style {
            display: none;
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #bfdbfe;
            border-top-color: #2563eb;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .score-card {
            border: 1px solid #dbeafe;
            background: #eff6ff;
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
        }

        .issues {
            margin-top: 8px;
            padding-left: 18px;
        }
    </style>
</head>

<body>
    <div class="layout">
        <h1>Audibound Studio</h1>
        <div id="flash" class="flash"></div>

        <div class="card">
            <h2>Create a project</h2>
            <input type="text" id="title" placeholder="Project Title" />
            <textarea id="text" rows="6" placeholder="Paste story text here..."></textarea>
            <button onclick="createProject()">Create Project</button>
        </div>

        <div id="global-outputs" class="card"></div>

        <div id="projects" class="projects-empty">No projects yet. Create one to get started.</div>
    </div>

    <script>
        const API_URL = "";
        const ENGINE_OPTIONS = [
            { value: "kokoro_multi", label: "Kokoro (multi-voice)" },
            { value: "kokoro_single", label: "Kokoro (single voice preview)" },
            { value: "styletts2", label: "StyleTTS2 (expressive multi-voice)" },
            { value: "sesame", label: "Sesame CSM (expressive)" }
        ];

        const projectStore = {};
        const projectOrder = [];
        const projectPollers = {};
        let globalOutputs = [];
        const STYLE_OPTIONS = [
            'neutral', 'calm', 'joyful', 'excited', 'angry', 'furious', 'sad', 'melancholy', 'tired', 'somber', 'whispering', 'soft', 'urgent', 'surprised'
        ];

        function showFlash(message, type = "info") {
            const el = document.getElementById('flash');
            if (!message) { el.style.display = 'none'; return; }
            el.textContent = message;
            el.className = `flash ${type}`;
            el.style.display = 'block';
        }

        function ensureProjectEntry(data) {
            const id = data.project_id;
            if (!id) return null;
            if (!projectStore[id]) {
                projectStore[id] = {
                    project_id: id,
                    title: data.title || 'Untitled project',
                    status: data.status || 'created',
                    selectedEngine: data.last_engine || 'kokoro_multi',
                    events: [],
                    tab: 'direction',
                    voice_overrides: data.voice_overrides || {},
                    render_history: data.render_history || [],
                    characters: data.characters || [],
                    availableVoices: data.available_voices || {},
                    validation_summary: data.validation_summary || null,
                    loadingAction: null,
                    productionOptions: {
                        include_voice: true,
                        include_sfx: true,
                        include_music: true,
                        reuse_voice_cache: true,
                    },
                };
                projectOrder.unshift(id);
            }
            const project = projectStore[id];
            if (data.title !== undefined) project.title = data.title || project.title;
            if (data.status !== undefined) project.status = data.status;
            if (data.manifest !== undefined) project.manifest = data.manifest;
            if (data.bible !== undefined) project.bible = data.bible;
            if (data.output_path !== undefined) project.output_path = data.output_path;
            if (data.last_engine && !project.loadingAction) project.last_engine = data.last_engine;
            if (data.characters !== undefined) project.characters = data.characters || [];
            if (data.available_voices !== undefined) project.availableVoices = data.available_voices || {};
            if (data.render_history !== undefined) project.render_history = data.render_history || [];
            if (data.voice_overrides !== undefined) project.voice_overrides = data.voice_overrides || {};
            if (data.validation_summary !== undefined) project.validation_summary = data.validation_summary || null;
            project.updated_at = new Date().toLocaleTimeString();
            return project;
        }

        function addProjectEvent(projectId, message) {
            const project = projectStore[projectId];
            if (!project) return;
            project.events = project.events || [];
            project.events.unshift({ message, timestamp: new Date().toLocaleTimeString() });
            project.events = project.events.slice(0, 6);
            renderProjects();
        }

        function renderProjects() {
            const container = document.getElementById('projects');
            if (!projectOrder.length) {
                container.className = 'projects-empty';
                container.innerHTML = 'No projects yet. Create one to get started.';
                return;
            }
            container.className = '';
            container.innerHTML = projectOrder.map(id => renderProjectCard(projectStore[id])).join('');
        }

        function renderProjectCard(project) {
            if (!project) return '';
            const tabs = `
                <div class="tabs">
                    <div class="tab ${project.tab === 'direction' ? 'active' : ''}" onclick="switchTab('${project.project_id}','direction')">Direction</div>
                    <div class="tab ${project.tab === 'production' ? 'active' : ''}" onclick="switchTab('${project.project_id}','production')">Production</div>
                </div>
            `;
            const directionView = renderDirectionView(project);
            const productionView = renderProductionView(project);
            return `
                <div class="card" data-project="${project.project_id}">
                    <div class="panel-header">
                        <div>
                            <h3 style="margin:0;">${project.title}</h3>
                            <p class="small">Status: <strong>${project.status}</strong></p>
                        </div>
                        <div>
                            <span class="pill">ID: ${project.project_id.slice(0, 8)}…</span>
                        </div>
                    </div>
                    ${tabs}
                    ${project.tab === 'direction' ? directionView : productionView}
                </div>
            `;
        }

        function renderDirectionView(project) {
            const validation = project.validation_summary;
            const validationCard = validation ? `
                <div class="score-card">
                    <strong>Quality Score: ${validation.score}/100</strong>
                    ${validation.issues && validation.issues.length ? `<div class="issues"><strong>Issues:</strong><ul>${validation.issues.map(i => `<li>${i}</li>`).join('')}</ul></div>` : ''}
                    ${validation.warnings && validation.warnings.length ? `<div class="issues"><strong>Warnings:</strong><ul>${validation.warnings.map(i => `<li>${i}</li>`).join('')}</ul></div>` : ''}
                    ${validation.clarifications && validation.clarifications.length ? `<div class="issues"><strong>Needs clarification (click to copy):</strong><ul>${validation.clarifications.map((c, idx) => `<li><button style="padding:4px 8px; margin-right:6px; background:#e0e7ff; color:#1d4ed8; border:none; border-radius:6px; cursor:pointer;" onclick="copyText('${project.project_id}', ${idx})">Copy</button> [Block ${c.block_index}] ${c.reason}: “${c.text.replace(/"/g, '&quot;')}”</li>`).join('')}</ul></div>` : ''}
                </div>`
                : '<p class="muted">Run Direct Script to generate the character breakdown and quality score.</p>';

            const characters = (project.characters && project.characters.length)
                ? renderCharacterList(project)
                : '<p class="muted">Characters will appear after directing this script.</p>';

            const directing = project.loadingAction === 'direct';
            return `
                <div>
                    <div class="panel-header" style="margin-bottom:12px;">
                        <div>
                            <p class="small">Current status: ${project.status}</p>
                        </div>
                        <div>
                            <button onclick="triggerAction('${project.project_id}', 'direct')" ${directing ? 'disabled' : ''}>
                                ${directing ? '<span class="spinner"></span>Directing…' : 'Direct Script'}
                            </button>
                        </div>
                    </div>
                    ${validationCard}
                    <div class="two-column" style="margin-top:16px;">
                        <div>
                            <h4>Characters</h4>
                            ${characters}
                            ${project.characters && project.characters.length ? '<button onclick="saveOverrides(\'' + project.project_id + '\')">Save Direction Changes</button>' : ''}
                        </div>
                        <div>
                            <h4>Recent activity</h4>
                            ${renderEvents(project)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCharacterList(project) {
            const voices = project.availableVoices || {};
            return `<div class="list">${project.characters.map(char => {
                const overrides = project.voice_overrides || {};
                const hasOverride = overrides[char.name] && overrides[char.name].voice;
                const currentVoice = hasOverride ? overrides[char.name].voice : char.default_voice;
                const currentStyle = overrides[char.name]?.style || '';
                const defaultSelected = hasOverride ? '' : 'selected';

                // Parse default voice to display engine name
                let defaultVoiceDisplay = char.default_voice;
                if (char.default_voice && char.default_voice.includes(':')) {
                    const [engine, voiceId] = char.default_voice.split(':', 2);
                    const engineName = engine.charAt(0).toUpperCase() + engine.slice(1);
                    defaultVoiceDisplay = `${voiceId} (${engineName})`;
                }

                const optionItems = [`<option value="" ${defaultSelected}>Use ${defaultVoiceDisplay}</option>`]
                    .concat(Object.entries(voices).map(([id, label]) => {
                        // Parse voice ID to display friendly format
                        let displayText = id;
                        if (id.includes(':')) {
                            const [engine, voiceId] = id.split(':', 2);
                            const engineName = engine.charAt(0).toUpperCase() + engine.slice(1);
                            displayText = `${voiceId} (${engineName})`;
                        }
                        displayText += ` — ${label}`;
                        return `<option value="${id}" ${hasOverride && currentVoice === id ? 'selected' : ''}>${displayText}</option>`;
                    }))
                    .join('');
                return `
                    <div class="list-item">
                        <h4 style="margin:0 0 4px 0;">${char.name}</h4>
                        <p class="small">${char.description || 'No description'}</p>
                        <label class="small">Voice</label>
                        <select onchange="updateOverride('${project.project_id}','${char.name}','voice', this.value)">${optionItems}</select>
                        <label class="small">Style override</label>
                        <select data-custom-style-select="${project.project_id}-${char.name}" onchange="handleStyleSelect('${project.project_id}','${char.name}', this.value)">
                            <option value="" ${currentStyle ? '' : 'selected'}>Use base emotion</option>
                            ${STYLE_OPTIONS.map(opt => `<option value="${opt}" ${currentStyle === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            <option value="custom-${char.name}" ${currentStyle && !STYLE_OPTIONS.includes(currentStyle) ? 'selected' : ''}>Custom…</option>
                        </select>
                        <input type="text" class="custom-style" placeholder="Custom style" value="${currentStyle && !STYLE_OPTIONS.includes(currentStyle) ? currentStyle : ''}" data-custom-style-input="${project.project_id}-${char.name}" style="display:${currentStyle && !STYLE_OPTIONS.includes(currentStyle) ? 'block' : 'none'}; margin-top:6px;" onblur="handleCustomStyleBlur('${project.project_id}','${char.name}', this.value)" />
                    </div>`;
            }).join('')}</div>`;
        }

        function renderProductionView(project) {
            const opts = project.productionOptions || { include_voice: true, include_sfx: true, include_music: true, reuse_voice_cache: true };
            const history = (project.render_history && project.render_history.length)
                ? project.render_history.map(entry => `
                    <div class="history-entry">
                        <span>${entry.timestamp} — ${entry.engine} ${entry.layers ? ' · ' + entry.layers.join(' / ') : ''}</span>
                        <div style="display:flex; gap:8px;">
                            ${entry.output_path ? `
                                <button onclick="playAudio('${entry.output_path}')" style="padding:4px 10px; font-size:0.85rem;">▶ Play</button>
                                <a href="${entry.output_path}" download style="padding:4px 10px; background:#10b981; color:#fff; border-radius:6px; text-decoration:none; font-size:0.85rem;">⬇ Download</a>
                            ` : '<span class="muted">Pending</span>'}
                        </div>
                        ${entry.notes && entry.notes.length ? `<div class="muted small" style="margin-top:4px;">${entry.notes.join(' | ')}</div>` : ''}
                    </div>`).join('')
                : '<p class="muted">No productions yet.</p>';
            return `
                <div class="two-column">
                    <div>
                        <h4>Produce Audio</h4>
                        <p class="small muted">Engine is automatically detected from character voice assignments</p>
                        <div class="list" style="margin:12px 0;">
                            <div class="small" style="margin-bottom:6px;">Layers to render:</div>
                            <label class="small" style="display:block; margin-bottom:4px;">
                                <input type="checkbox" ${opts.include_voice ? 'checked' : ''} onchange="setProdOption('${project.project_id}','include_voice', this.checked)"> Voice
                            </label>
                            <label class="small" style="display:block; margin-bottom:4px;">
                                <input type="checkbox" ${opts.include_sfx ? 'checked' : ''} onchange="setProdOption('${project.project_id}','include_sfx', this.checked)"> SFX
                            </label>
                            <label class="small" style="display:block; margin-bottom:4px;">
                                <input type="checkbox" ${opts.include_music ? 'checked' : ''} onchange="setProdOption('${project.project_id}','include_music', this.checked)"> Music
                            </label>
                            <label class="small" style="display:block; margin-top:6px;">
                                <input type="checkbox" ${opts.reuse_voice_cache ? 'checked' : ''} onchange="setProdOption('${project.project_id}','reuse_voice_cache', this.checked)"> Reuse voice cache (skip regen when possible)
                            </label>
                            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;">
                                <button style="padding:6px 10px; background:#e5e7eb; color:#111827;" onclick="applyPreset('${project.project_id}','voice')">Voice only</button>
                                <button style="padding:6px 10px; background:#e5e7eb; color:#111827;" onclick="applyPreset('${project.project_id}','sfx')">SFX only</button>
                                <button style="padding:6px 10px; background:#e5e7eb; color:#111827;" onclick="applyPreset('${project.project_id}','music')">Music only</button>
                                <button style="padding:6px 10px; background:#e5e7eb; color:#111827;" onclick="applyPreset('${project.project_id}','all')">All layers</button>
                            </div>
                        </div>
                        <div class="flex" style="gap:12px; margin-top:14px; flex-wrap:wrap;">
                            <button onclick="triggerAction('${project.project_id}', 'produce')" ${project.manifest ? '' : 'disabled title="Run Direct Script first"'} ${project.loadingAction === 'produce' ? 'disabled' : ''}>
                                ${project.loadingAction === 'produce' ? '<span class="spinner"></span>Producing…' : 'Produce Audio'}
                            </button>
                        </div>
                        <h4 style="margin-top:20px;">Render History</h4>
                        <div class="list">${history}</div>
                    </div>
                    <div>
                        <h4>Recent activity</h4>
                        ${renderEvents(project)}
                    </div>
                </div>
            `;
        }

        function renderEvents(project) {
            if (!project.events || !project.events.length) {
                return '<p class="muted">No activity yet.</p>';
            }
            return `<ul>${project.events.map(evt => `<li class="history-entry"><span>${evt.message}</span><span>${evt.timestamp}</span></li>`).join('')}</ul>`;
        }

        async function createProject() {
            const title = document.getElementById('title').value.trim();
            const text = document.getElementById('text').value.trim();
            if (!title || !text) { showFlash('Title and text are required.', 'error'); return; }
            showFlash('Creating project…');
            try {
                const res = await fetch(`${API_URL}/projects`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, text })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Failed to create project');
                ensureProjectEntry(data);
                renderProjects();
                showFlash('Project created. Run Direct Script to generate direction data.', 'success');
            } catch (err) {
                showFlash(err.message, 'error');
            }
        }

        function switchTab(projectId, tab) {
            const project = projectStore[projectId];
            if (!project) return;
            project.tab = tab;
            renderProjects();
        }

        function updateEngine(projectId, value) {
            const project = projectStore[projectId];
            if (!project) return;
            project.selectedEngine = value;
            addProjectEvent(projectId, `Voice engine set to ${value}`);
        }

        function handleStyleSelect(projectId, characterName, value) {
            const input = document.querySelector(`[data-custom-style-input=\"${projectId}-${characterName}\"]`);
            if (value.startsWith('custom-')) {
                if (input) { input.style.display = 'block'; input.focus(); }
            } else {
                if (input) input.style.display = 'none';
                updateOverride(projectId, characterName, 'style', value);
            }
        }

        function handleCustomStyleBlur(projectId, characterName, value) {
            updateOverride(projectId, characterName, 'style', value);
            const selectEl = document.querySelector(`[data-custom-style-select=\"${projectId}-${characterName}\"]`);
            const input = document.querySelector(`[data-custom-style-input=\"${projectId}-${characterName}\"]`);
            if (value) {
                if (selectEl) selectEl.value = `custom-${characterName}`;
                if (input) input.style.display = 'block';
            } else {
                if (selectEl) selectEl.value = '';
                if (input) input.style.display = 'none';
            }
        }

        function updateOverride(projectId, characterName, field, value) {
            const project = projectStore[projectId];
            if (!project) return;
            project.voice_overrides = project.voice_overrides || {};
            project.voice_overrides[characterName] = project.voice_overrides[characterName] || {};
            project.voice_overrides[characterName][field] = value || undefined;
        }

        function setProdOption(projectId, key, value) {
            const project = projectStore[projectId];
            if (!project) return;
            project.productionOptions = project.productionOptions || {
                include_voice: true,
                include_sfx: true,
                include_music: true,
                reuse_voice_cache: true
            };
            project.productionOptions[key] = value;
            renderProjects();
        }

        function applyPreset(projectId, preset) {
            const presets = {
                voice: { include_voice: true, include_sfx: false, include_music: false },
                sfx: { include_voice: false, include_sfx: true, include_music: false },
                music: { include_voice: false, include_sfx: false, include_music: true },
                all: { include_voice: true, include_sfx: true, include_music: true }
            };
            const chosen = presets[preset] || presets.all;
            setProdOption(projectId, 'include_voice', chosen.include_voice);
            setProdOption(projectId, 'include_sfx', chosen.include_sfx);
            setProdOption(projectId, 'include_music', chosen.include_music);
        }

        async function saveOverrides(projectId) {
            const project = projectStore[projectId];
            if (!project) return;
            try {
                const res = await fetch(`${API_URL}/projects/${projectId}/overrides`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ overrides: project.voice_overrides || {} })
                });
                if (!res.ok) throw new Error('Failed to save overrides');
                addProjectEvent(projectId, 'Overrides saved');
                showFlash('Direction overrides saved.', 'success');
                await loadProject(projectId, { silent: true });
            } catch (err) {
                showFlash(err.message, 'error');
            }
        }

        function copyText(projectId, clarificationIndex) {
            const project = projectStore[projectId];
            if (!project || !project.validation_summary || !project.validation_summary.clarifications) return;
            const item = project.validation_summary.clarifications[clarificationIndex];
            if (!item) return;
            const text = item.text || '';
            navigator.clipboard.writeText(text).then(() => {
                showFlash('Copied snippet to clipboard.', 'success');
            }).catch(() => showFlash('Unable to copy.', 'error'));
        }

        async function triggerAction(projectId, action) {
            const project = projectStore[projectId];
            if (!project || project.loadingAction) return;
            project.loadingAction = action;
            renderProjects();
            const humanAction = action === 'direct' ? 'Direction' : 'Production';
            addProjectEvent(projectId, `${humanAction} requested…`);
            const fetchOptions = { method: 'POST' };
            if (action === 'produce') {
                // Auto-detect engine from character voice assignments
                // Default to kokoro_multi, but this will be overridden by per-character engines
                const engine = 'kokoro_multi';
                const opts = project.productionOptions || { include_voice: true, include_sfx: true, include_music: true, reuse_voice_cache: true };
                fetchOptions.headers = { 'Content-Type': 'application/json' };
                fetchOptions.body = JSON.stringify({
                    engine,
                    include_voice: !!opts.include_voice,
                    include_sfx: !!opts.include_sfx,
                    include_music: !!opts.include_music,
                    reuse_voice_cache: !!opts.reuse_voice_cache
                });
            }
            try {
                const res = await fetch(`${API_URL}/projects/${projectId}/${action}`, fetchOptions);
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || data.message || `Failed to start ${action}`);
                if (data.engine) project.last_engine = data.engine;
                addProjectEvent(projectId, `${humanAction} queued${data.engine ? ` (${data.engine})` : ''}`);
                const targetStatus = action === 'direct' ? 'directed' : 'produced';
                startPolling(projectId, targetStatus);
            } catch (err) {
                project.loadingAction = null;
                renderProjects();
                addProjectEvent(projectId, `⚠️ ${humanAction} failed: ${err.message}`);
            }
        }

        function startPolling(projectId, stopStatus) {
            if (projectPollers[projectId]) clearInterval(projectPollers[projectId]);

            // Add a timeout to prevent infinite polling (5 minutes max)
            const startTime = Date.now();
            const maxDuration = 5 * 60 * 1000; // 5 minutes

            projectPollers[projectId] = setInterval(async () => {
                const data = await loadProject(projectId, { silent: true });
                const currentStatus = data?.status || projectStore[projectId]?.status;
                const elapsed = Date.now() - startTime;

                // Stop if we reached the target status OR if we see 'produced'/'directed' (terminal states)
                const terminalStates = ['produced', 'directed', 'error', 'failed'];
                const shouldStop = currentStatus === stopStatus || terminalStates.includes(currentStatus);

                // Also stop if we've been polling for too long
                if (shouldStop || elapsed > maxDuration) {
                    clearInterval(projectPollers[projectId]);
                    delete projectPollers[projectId];
                    const project = projectStore[projectId];
                    if (project) {
                        project.loadingAction = null;
                        renderProjects();
                        if (elapsed > maxDuration) {
                            addProjectEvent(projectId, '⚠️ Polling timeout - refresh the page to see the latest status');
                        }
                    }
                }
            }, 4000);
        }

        async function loadProject(projectId, options = {}) {
            try {
                const res = await fetch(`${API_URL}/projects/${projectId}`);
                if (!res.ok) throw new Error('Unable to load project');
                const data = await res.json();
                const project = ensureProjectEntry(data);
                if (project && project.loadingAction) {
                    if (project.loadingAction === 'direct' && data.status === 'directed') {
                        project.loadingAction = null;
                    } else if (project.loadingAction === 'produce' && data.status === 'produced') {
                        project.loadingAction = null;
                    }
                }
                renderProjects();
                if (!options.silent) addProjectEvent(projectId, `Status updated to ${data.status}`);
                return data;
            } catch (err) {
                if (!options.silent) addProjectEvent(projectId, `⚠️ Refresh failed: ${err.message}`);
                return null;
            }
        }

        function playAudio(audioPath) {
            // Create or reuse audio player
            let player = document.getElementById('global-audio-player');
            if (!player) {
                player = document.createElement('audio');
                player.id = 'global-audio-player';
                player.controls = true;
                player.style.cssText = 'position:fixed; bottom:20px; right:20px; z-index:1000; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3);';
                document.body.appendChild(player);
            }
            player.src = audioPath;
            player.play();
        }

        async function loadGlobalOutputs() {
            try {
                const res = await fetch('/outputs/tracks');
                if (!res.ok) throw new Error('Unable to load outputs');
                const data = await res.json();
                // Flatten produced list for the home card
                globalOutputs = data.produced || [];
                renderGlobalOutputs();
            } catch (err) {
                console.error(err);
            }
        }

        function renderGlobalOutputs() {
            const container = document.getElementById('global-outputs');
            if (!container) return;
            if (!globalOutputs.length) {
                container.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin-top:0;">Recent renders</h3><a href="/static/multitrack_player.html" style="text-decoration:none; color:#2563eb;">Multi-Track Player ↗</a></div><p class="muted small">No renders found on disk.</p>';
                return;
            }
            const items = globalOutputs.map(item => `
                <div class="history-entry">
                    <div>
                        <div>${item.name}</div>
                        <div class="muted small">${item.modified} · ${(item.size_kb || 0).toLocaleString()} KB</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="playAudio('${item.url}')" style="padding:4px 10px; font-size:0.85rem;">▶ Play</button>
                        <a href="${item.url}" download style="padding:4px 10px; background:#10b981; color:#fff; border-radius:6px; text-decoration:none; font-size:0.85rem;">⬇ Download</a>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin-top:0;">Recent renders</h3><a href="/static/multitrack_player.html" style="text-decoration:none; color:#2563eb;">Multi-Track Player ↗</a></div><div class="list">${items}</div>`;
        }

        // Initial load
        loadGlobalOutputs();

    </script>
</body>

</html>
